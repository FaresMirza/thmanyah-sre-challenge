apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: prometheus-ns
data:
  alerts.yml: |
    groups:
      # ===== Service Availability Alerts =====
      - name: service_availability
        interval: 5s
        rules:
          - alert: ServiceDown
            expr: up{job=~"api-service|auth-service|image-service"} == 0
            for: 5s
            labels:
              severity: critical
              component: "{{ $labels.job }}"
            annotations:
              summary: "Service {{ $labels.job }} is down"
              description: "{{ $labels.job }} has been down for more than 15 seconds."

          - alert: HighPodRestartRate
            expr: rate(kube_pod_container_status_restarts_total{namespace=~"api-ns|auth-ns|image-ns"}[15m]) > 0.1
            for: 5s
            labels:
              severity: warning
              component: kubernetes
            annotations:
              summary: "High pod restart rate in {{ $labels.namespace }}"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting frequently."

      # ===== API Service Alerts =====
      - name: api_service
        interval: 5s
        rules:
          - alert: APIHighErrorRate
            expr: |
              (sum(rate(http_requests_total{job="api-service",status_code=~"5.."}[5m])) by (instance) 
              / sum(rate(http_requests_total{job="api-service"}[5m])) by (instance)) > 0.05
            for: 5s
            labels:
              severity: critical
              component: api-service
            annotations:
              summary: "API service has high error rate"
              description: "API service error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

          - alert: APIHighLatency
            expr: |
              histogram_quantile(0.95, 
                sum(rate(http_request_duration_seconds_bucket{job="api-service"}[5m])) by (le)
              ) > 1
            for: 5s
            labels:
              severity: warning
              component: api-service
            annotations:
              summary: "API service has high latency"
              description: "API service p95 latency is {{ $value }}s (threshold: 1s)"

          - alert: APILowThroughput
            expr: sum(rate(http_requests_total{job="api-service"}[5m])) < 0.1
            for: 5s
            labels:
              severity: info
              component: api-service
            annotations:
              summary: "API service has low throughput"
              description: "API service is receiving {{ $value }} requests/second"

      # ===== Auth Service Alerts =====
      - name: auth_service
        interval: 5s
        rules:
          - alert: AuthServiceHighErrorRate
            expr: |
              (sum(rate(http_requests_total{job="auth-service",status=~"Internal Server Error|Bad Gateway|Service Unavailable|Gateway Timeout"}[5m])) by (instance)
              / sum(rate(http_requests_total{job="auth-service"}[5m])) by (instance)) > 0.05
            for: 5s
            labels:
              severity: critical
              component: auth-service
            annotations:
              summary: "Auth service has high error rate"
              description: "Auth service error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

          - alert: AuthServiceHighLatency
            expr: |
              histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket{job="auth-service"}[5m])) by (le)
              ) > 0.5
            for: 5s
            labels:
              severity: warning
              component: auth-service
            annotations:
              summary: "Auth service has high latency"
              description: "Auth service p95 latency is {{ $value }}s (threshold: 0.5s)"

          - alert: HighFailedLoginAttempts
            expr: |
              sum(rate(http_requests_total{job="auth-service",endpoint="/login",status="Unauthorized"}[5m])) by (instance) > 5
            for: 5s
            labels:
              severity: warning
              component: auth-service
            annotations:
              summary: "High failed login attempts detected"
              description: "Auth service is experiencing {{ $value }} failed logins/second on {{ $labels.instance }}"

      # ===== Image Service Alerts =====
      - name: image_service
        interval: 5s
        rules:
          - alert: ImageServiceHighErrorRate
            expr: |
              (sum(rate(http_requests_total{job="image-service",status=~"5.."}[5m])) by (instance)
              / sum(rate(http_requests_total{job="image-service"}[5m])) by (instance)) > 0.05
            for: 5s
            labels:
              severity: critical
              component: image-service
            annotations:
              summary: "Image service has high error rate"
              description: "Image service error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

          - alert: ImageProcessingHighLatency
            expr: |
              histogram_quantile(0.95,
                sum(rate(http_request_duration_seconds_bucket{job="image-service"}[5m])) by (le)
              ) > 3
            for: 5s
            labels:
              severity: warning
              component: image-service
            annotations:
              summary: "Image service has high processing latency"
              description: "Image service p95 latency is {{ $value }}s (threshold: 3s)"

      # ===== Database Alerts =====
      - name: database
        interval: 5s
        rules:
          - alert: PostgreSQLDown
            expr: up{job="postgres"} == 0
            for: 5s
            labels:
              severity: critical
              component: database
            annotations:
              summary: "PostgreSQL database is down"
              description: "PostgreSQL has been unreachable for more than 2 minutes."

          - alert: HighDatabaseConnections
            expr: |
              pg_stat_database_numbackends{datname!~"template.*|postgres"} 
              / pg_settings_max_connections > 0.8
            for: 5s
            labels:
              severity: warning
              component: database
            annotations:
              summary: "High database connection usage"
              description: "Database connection usage is {{ $value | humanizePercentage }} (threshold: 80%)"

      # ===== Resource Utilization Alerts =====
      - name: resource_utilization
        interval: 5s
        rules:
          # Alert when HPA is scaling due to high resource usage
          - alert: ServiceHighResourceUsage
            expr: |
              kube_horizontalpodautoscaler_status_current_replicas{namespace=~"api-ns|auth-ns|image-ns"}
              > kube_horizontalpodautoscaler_spec_min_replicas{namespace=~"api-ns|auth-ns|image-ns"}
            for: 5s
            labels:
              severity: warning
              component: kubernetes
            annotations:
              summary: "Service in {{ $labels.namespace }} is under high load"
              description: "HPA {{ $labels.horizontalpodautoscaler }} has scaled to {{ $value }} replicas due to high resource usage"

          - alert: PodCrashLooping
            expr: |
              rate(kube_pod_container_status_restarts_total{namespace=~"api-ns|auth-ns|image-ns|data-ns"}[15m]) > 0
            for: 5s
            labels:
              severity: critical
              component: kubernetes
            annotations:
              summary: "Pod is crash looping"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is crash looping"

      # ===== Storage Alerts =====
      - name: storage
        interval: 5s
        rules:
          - alert: PersistentVolumeClaimPending
            expr: |
              kube_persistentvolumeclaim_status_phase{phase="Pending",namespace=~"data-ns|prometheus-ns"} == 1
            for: 5s
            labels:
              severity: warning
              component: storage
            annotations:
              summary: "PVC {{ $labels.persistentvolumeclaim }} is pending"
              description: "PVC {{ $labels.persistentvolumeclaim }} in {{ $labels.namespace }} has been pending for 5 seconds"

      # ===== Network Alerts =====
      - name: networking
        interval: 5s
        rules:
          - alert: IngressHighErrorRate
            expr: |
              sum(rate(nginx_ingress_controller_requests{status=~"5.."}[5m])) by (ingress)
              / sum(rate(nginx_ingress_controller_requests[5m])) by (ingress) > 0.05
            for: 5s
            labels:
              severity: warning
              component: ingress
            annotations:
              summary: "Ingress {{ $labels.ingress }} has high error rate"
              description: "Ingress error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

          - alert: PodNotReady
            expr: |
              kube_pod_status_phase{namespace=~"api-ns|auth-ns|image-ns|data-ns",phase!="Running"} == 1
            for: 5s
            labels:
              severity: warning
              component: networking
            annotations:
              summary: "Pod {{ $labels.pod }} is not ready"
              description: "Pod {{ $labels.pod }} in {{ $labels.namespace }} has been in {{ $labels.phase }} state for 5 seconds"

      # ===== HPA Alerts =====
      - name: autoscaling
        interval: 5s
        rules:
          - alert: HPAMaxedOut
            expr: |
              kube_horizontalpodautoscaler_status_current_replicas{namespace=~"api-ns|auth-ns|image-ns"}
              / kube_horizontalpodautoscaler_spec_max_replicas{namespace=~"api-ns|auth-ns|image-ns"} >= 1
            for: 5s
            labels:
              severity: warning
              component: autoscaling
            annotations:
              summary: "HPA {{ $labels.horizontalpodautoscaler }} has reached max replicas"
              description: "HPA in {{ $labels.namespace }} has been at maximum capacity for 15 minutes"

          - alert: HPAScalingDisabled
            expr: |
              kube_horizontalpodautoscaler_status_condition{condition="ScalingActive",status="false"} == 1
            for: 30s
            labels:
              severity: warning
              component: autoscaling
            annotations:
              summary: "HPA {{ $labels.horizontalpodautoscaler }} scaling is disabled"
              description: "HPA scaling is disabled in {{ $labels.namespace }}"

          - alert: ImageServiceHighLoad
            expr: |
              kube_horizontalpodautoscaler_status_current_replicas{namespace="image-ns",horizontalpodautoscaler="image-hpa"}
              > kube_horizontalpodautoscaler_spec_min_replicas{namespace="image-ns",horizontalpodautoscaler="image-hpa"}
            for: 5s
            labels:
              severity: warning
              component: image-service
            annotations:
              summary: "Image service is under high load"
              description: "Image service HPA has scaled to {{ $value }} replicas due to high load (CPU or memory threshold exceeded)"

          - alert: ImageServiceScalingUp
            expr: |
              kube_horizontalpodautoscaler_status_desired_replicas{namespace="image-ns",horizontalpodautoscaler="image-hpa"}
              > kube_horizontalpodautoscaler_status_current_replicas{namespace="image-ns",horizontalpodautoscaler="image-hpa"}
            for: 5s
            labels:
              severity: info
              component: image-service
            annotations:
              summary: "Image service is scaling up"
              description: "Image service HPA is scaling up to handle increased load (desired: {{ $value }} replicas)"

      # ===== Prometheus Self-Monitoring =====
      - name: prometheus_self
        interval: 5s
        rules:
          - alert: PrometheusConfigReloadFailed
            expr: prometheus_config_last_reload_successful == 0
            for: 5s
            labels:
              severity: critical
              component: prometheus
            annotations:
              summary: "Prometheus configuration reload failed"
              description: "Prometheus configuration reload has failed"

          - alert: PrometheusTargetDown
            expr: up == 0
            for: 5s
            labels:
              severity: warning
              component: prometheus
            annotations:
              summary: "Prometheus target {{ $labels.job }} is down"
              description: "Prometheus cannot scrape {{ $labels.job }} on {{ $labels.instance }}"
